<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×›×œ×™ × ×™×ª×•×— ×ª×™×¢×“×•×£ ××ª×’×¨×™×</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .upload-section {
            border: 2px dashed #3498db;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 10px;
            background-color: #ecf0f1;
        }
        .upload-section:hover {
            background-color: #d5dbdb;
        }
        input[type="file"] {
            margin: 10px;
            padding: 10px;
            font-size: 16px;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        /* --- [×©×™× ×•×™] ×¢×™×¦×•×‘ ×œ×›×¤×ª×•×¨×™ ×”×¤×¢×•×œ×” ×”×—×“×©×™× --- */
        .action-buttons {
            text-align: center;
            margin: 30px 0;
        }
        .action-buttons button {
            background-color: #27ae60; /* ×¦×‘×¢ ×™×¨×•×§ ×œ×”×•×¨×“×” */
        }
        .action-buttons button.print-btn {
            background-color: #8e44ad; /* ×¦×‘×¢ ×¡×’×•×œ ×œ×”×“×¤×¡×” */
        }
        .action-buttons button:hover {
            opacity: 0.9;
        }
        #resultsActions {
            display: none; /* ×”×¡×ª×¨×” ×›×‘×¨×™×¨×ª ××—×“×œ */
        }
        .results {
            margin-top: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        th {
            background-color: #34495e;
            color: white;
        }
        .top5 {
            background-color: #e8f5e8;
        }
        .rank-1 { background-color: #f1c40f; color: #2c3e50; font-weight: bold; }
        .rank-2 { background-color: #95a5a6; color: white; font-weight: bold; }
        .rank-3 { background-color: #e67e22; color: white; font-weight: bold; }
        .summary {
            background-color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .criteria-legend {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        /* --- [×—×“×©] ×¡×’× ×•× ×•×ª ×”×“×¤×¡×” --- */
        @media print {
            body {
                background-color: white;
            }
            .no-print {
                display: none !important; /* ×”×¡×ª×¨×ª ×›×œ ×”××œ×× ×˜×™× ×©×œ× ×¨×œ×•×•× ×˜×™×™× ×œ×”×“×¤×¡×” */
            }
            .container {
                box-shadow: none;
                padding: 0;
                margin: 0;
                max-width: 100%;
            }
            table {
                font-size: 12px; /* ×”×§×˜× ×ª ×”×¤×•× ×˜ ×œ×”×ª×××” ×œ×“×£ */
            }
            th, td {
                padding: 8px;
            }
            /* ×›×•×¤×” ×¢×œ ×”×“×¤×“×¤×Ÿ ×œ×”×“×¤×™×¡ ×¦×‘×¢×™ ×¨×§×¢ */
            .rank-1, .rank-2, .rank-3, .top5, th {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- [×©×™× ×•×™] ×”×•×¡×¤×ª ×§×œ××¡ no-print ×œ××œ×× ×˜×™× ×©×‘×¨×¦×•× × ×• ×œ×”×¡×ª×™×¨ ×‘×”×“×¤×¡×” -->
        <h1 class="no-print">ğŸ¯ ×›×œ×™ × ×™×ª×•×— ×ª×™×¢×“×•×£ ××ª×’×¨×™×</h1>
        
        <div class="criteria-legend no-print">
            <h3>ğŸ“‹ ×”×§×¨×™×˜×¨×™×•× ×™× ×œ×”×¢×¨×›×”:</h3>
            <ul>
                <li><strong>×§×¨×™×˜×¨×™×•×Ÿ 1 - ×™×™×©×™××•×ª:</strong> ×¢×“ ×›××” × ×™×ª×Ÿ ×œ×‘×¦×¢ ×‘×¤×•×¢×œ</li>
                <li><strong>×§×¨×™×˜×¨×™×•×Ÿ 2 - ×¨×œ×•×•× ×˜×™×•×ª:</strong> ×œ×’×™×œ ×”×™×¡×•×“×™ ×•×œ×ª×§×•×¤×”</li>
                <li><strong>×§×¨×™×˜×¨×™×•×Ÿ 3 - ×“×—×™×¤×•×ª:</strong> ×“×¨×’×ª ×”×“×—×™×¤×•×ª</li>
                <li><strong>×§×¨×™×˜×¨×™×•×Ÿ 4 - ×–×™×§×” ×œ×™×¢×“×™ ×”××©×¨×“:</strong> ×”×ª×××” ×œ××˜×¨×•×ª ×”××¨×’×•×Ÿ</li>
            </ul>
        </div>

        <div class="upload-section no-print">
            <h3>ğŸ“ ×”×¢×œ××ª ×§×•×‘×¥</h3>
            <p>×‘×—×¨×• ××ª ×”×§×•×‘×¥ ×”××™×•×¦× ×-Google Forms (×ª×•××š ×‘×¤×•×¨××˜×™×: CSV, XLS, XLSX)</p>
            <input type="file" id="fileInput" accept=".csv,.xls,.xlsx" />
            <br>
            <button onclick="processFile()">×¢×‘×“ ×§×•×‘×¥</button>
        </div>
        
        <div id="results" class="results">
            <!-- ×”×ª×•×¦××•×ª ×™×•×¦×’×• ×›××Ÿ -->
        </div>

        <!-- [×—×“×©] ××–×•×¨ ×›×¤×ª×•×¨×™× ×œ×”×•×¨×“×” ×•×”×“×¤×¡×” -->
        <div id="resultsActions" class="action-buttons no-print">
            <button onclick="downloadResults()">â¬‡ï¸ ×”×•×¨×“ ×ª×•×¦××•×ª (CSV)</button>
            <button onclick="window.print()" class="print-btn">ğŸ–¨ï¸ ×”×“×¤×¡ ×ª×•×¦××•×ª</button>
        </div>

    </div>

    <script>
        // --- [×—×“×©] ××©×ª× ×” ×’×œ×•×‘×œ×™ ×œ×©××™×¨×ª ×”×ª×•×¦××•×ª ×”××¢×•×‘×“×•×ª ---
        let processedResults = [];

        function processFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('×× × ×‘×—×¨×• ×§×•×‘×¥');
                return;
            }
            
            const fileName = file.name.toLowerCase();
            const fileExtension = fileName.split('.').pop();
            
            if (fileExtension === 'csv') {
                if (typeof Papa === 'undefined') {
                    alert('×©×’×™××”: ×¡×¤×¨×™×™×ª PapaParse ×œ× × ×˜×¢× ×”. ×× × ×¨×¢× × ×• ××ª ×”×“×£ ×•× ×¡×• ×©×•×‘.');
                    return;
                }
                
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (results.data) {
                            processData(results.data);
                        } else {
                            alert('×©×’×™××” ×‘×¢×™×‘×•×“ ×§×•×‘×¥ CSV.');
                        }
                    },
                    error: function(error) {
                        alert('×©×’×™××” ×‘×§×¨×™××ª ×§×•×‘×¥ CSV: ' + error.message);
                    }
                });
            } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                if (typeof XLSX === 'undefined') {
                    alert('×©×’×™××”: ×¡×¤×¨×™×™×ª XLSX ×œ× × ×˜×¢× ×”. ×× × ×¨×¢× × ×• ××ª ×”×“×£ ×•× ×¡×• ×©×•×‘.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        processData(jsonData);

                    } catch (error) {
                        alert('×©×’×™××” ×‘×§×¨×™××ª ×§×•×‘×¥ ×”××§×¡×œ: ' + error.message);
                        console.error('Excel processing error:', error);
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert('×¤×•×¨××˜ ×§×•×‘×¥ ×œ× × ×ª××š. ×× × ×‘×—×¨×• ×§×•×‘×¥ CSV, XLS ××• XLSX');
            }
        }

        function processData(data) {
            if (!data || data.length === 0) {
                alert("×œ× × ××¦××• × ×ª×•× ×™× ×œ×¢×™×‘×•×“ ×‘×§×•×‘×¥.");
                return;
            }
             
            const firstRow = data[0];
            if (!firstRow['××ª×’×¨ 1 [×§×¨×™×˜×¨×™×•×Ÿ 1 - ×™×™×©×™××•×ª]']) {
                 alert("×©×’×™××”: ××‘× ×” ×”×§×•×‘×¥ ××™× ×• ×ª×•×× ××ª ×”×¤×•×¨××˜ ×”× ×“×¨×©. ×•×“× ×©×”×›×•×ª×¨×•×ª ×ª×§×™× ×•×ª.");
                 console.error("Missing expected headers. First row:", firstRow);
                 return;
            }
            
            const challenges = {};
            for (let i = 1; i <= 10; i++) {
                challenges[`××ª×’×¨ ${i}`] = {
                    implementability: [],
                    relevance: [],
                    urgency: [],
                    alignment: []
                };
            }

            data.forEach(row => {
                for (let i = 1; i <= 10; i++) {
                    const challengeKey = `××ª×’×¨ ${i}`;
                    
                    const impl = parseFloat(row[`××ª×’×¨ ${i} [×§×¨×™×˜×¨×™×•×Ÿ 1 - ×™×™×©×™××•×ª]`]);
                    const rel = parseFloat(row[`××ª×’×¨ ${i} [×§×¨×™×˜×¨×™×•×Ÿ 2 - ×¨×œ×•×•× ×˜×™×•×ª ×œ×’×™×œ ×”×™×¡×•×“×™ ×•×œ×ª×§×•×¤×”]`]);
                    const urg = parseFloat(row[`××ª×’×¨ ${i} [×§×¨×™×˜×¨×™×•×Ÿ 3 - ×“×—×™×¤×•×ª]`]);
                    const align = parseFloat(row[`××ª×’×¨ ${i} [×§×¨×™×˜×¨×™×•×Ÿ 4 - ×–×™×§×” ×œ×™×¢×“×™ ×”××©×¨×“]`]);
                    
                    if (!isNaN(impl)) challenges[challengeKey].implementability.push(impl);
                    if (!isNaN(rel)) challenges[challengeKey].relevance.push(rel);
                    if (!isNaN(urg)) challenges[challengeKey].urgency.push(urg);
                    if (!isNaN(align)) challenges[challengeKey].alignment.push(align);
                }
            });

            const results = [];
            
            Object.keys(challenges).forEach(challenge => {
                const scores = challenges[challenge];
                
                const responseCount = scores.implementability.length;
                if (responseCount === 0) return; 

                const avgImpl = average(scores.implementability);
                const avgRel = average(scores.relevance);
                const avgUrg = average(scores.urgency);
                const avgAlign = average(scores.alignment);
                
                const overallAvg = (avgImpl + avgRel + avgUrg + avgAlign) / 4;
                
                results.push({
                    challenge: challenge,
                    implementability: avgImpl,
                    relevance: avgRel,
                    urgency: avgUrg,
                    alignment: avgAlign,
                    overall: overallAvg,
                    responseCount: responseCount
                });
            });
            
            results.sort((a, b) => b.overall - a.overall);
            
            // --- [×©×™× ×•×™] ×©××™×¨×ª ×”×ª×•×¦××•×ª ×‘××©×ª× ×” ×”×’×œ×•×‘×œ×™ ---
            processedResults = results;
            
            displayResults(results, data.length);
        }

        function average(arr) {
            if (arr.length === 0) return 0;
            return arr.reduce((a, b) => a + b, 0) / arr.length;
        }

        function displayResults(results, totalResponses) {
            const resultsDiv = document.getElementById('results');
            
            if (results.length === 0) {
                resultsDiv.innerHTML = `<div class="summary"><h3>×œ× × ××¦××• × ×ª×•× ×™× ×ª×§×¤×™× ×œ×—×™×©×•×‘.</h3><p>×× × ×•×“××• ×©×”×§×•×‘×¥ ××›×™×œ ×¦×™×•× ×™× ××¡×¤×¨×™×™× ×‘×¢××•×“×•×ª ×”××ª××™××•×ª.</p></div>`;
                // --- [×©×™× ×•×™] ×”×¡×ª×¨×ª ×”×›×¤×ª×•×¨×™× ×× ××™×Ÿ ×ª×•×¦××•×ª ---
                document.getElementById('resultsActions').style.display = 'none';
                return;
            }

            const top5 = results.slice(0, 5);
            
            let html = `
                <div class="summary">
                    <h2>ğŸ“Š ×¡×™×›×•× ×ª×•×¦××•×ª ×”×ª×™×¢×“×•×£</h2>
                    <p><strong>××¡×¤×¨ ×›×•×œ×œ ×©×œ ××©×™×‘×™×:</strong> ${totalResponses}</p>
                    <p><strong>×ª××¨×™×š ×¢×™×‘×•×“:</strong> ${new Date().toLocaleDateString('he-IL')}</p>
                </div>
                
                <div class="summary">
                    <h3>ğŸ† ×—××©×ª ×”××ª×’×¨×™× ×”××•×‘×™×œ×™×</h3>
                    <ol>
            `;
            
            top5.forEach(result => {
                html += `<li><strong>${result.challenge}</strong> - ×¦×™×•×Ÿ ×›×•×œ×œ: ${result.overall.toFixed(2)}</li>`;
            });
            
            html += `
                    </ol>
                </div>
                
                <h3>ğŸ“‹ ×˜×‘×œ×ª ×ª×•×¦××•×ª ××¤×•×¨×˜×ª</h3>
                <table>
                    <thead>
                        <tr>
                            <th>×“×™×¨×•×’</th>
                            <th>××ª×’×¨</th>
                            <th>×™×™×©×™××•×ª (×××•×¦×¢)</th>
                            <th>×¨×œ×•×•× ×˜×™×•×ª (×××•×¦×¢)</th>
                            <th>×“×—×™×¤×•×ª (×××•×¦×¢)</th>
                            <th>×–×™×§×” (×××•×¦×¢)</th>
                            <th>×¦×™×•×Ÿ ×›×•×œ×œ (×××•×¦×¢)</th>
                            <th>××¡×¤×¨ ××©×™×‘×™× ×œ××ª×’×¨</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            results.forEach((result, index) => {
                let rowClass = '';
                if (index < 5) rowClass += ' top5';
                if (index === 0) rowClass += ' rank-1';
                if (index === 1) rowClass += ' rank-2';
                if (index === 2) rowClass += ' rank-3';
                
                html += `
                    <tr class="${rowClass.trim()}">
                        <td><strong>${index + 1}</strong></td>
                        <td><strong>${result.challenge}</strong></td>
                        <td>${result.implementability.toFixed(2)}</td>
                        <td>${result.relevance.toFixed(2)}</td>
                        <td>${result.urgency.toFixed(2)}</td>
                        <td>${result.alignment.toFixed(2)}</td>
                        <td><strong>${result.overall.toFixed(2)}</strong></td>
                        <td>${result.responseCount}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                
                <div style="margin-top: 30px; padding: 20px; background-color: #e8f5e8; border-radius: 10px;">
                    <h3>ğŸ’¡ ×”××œ×¦×•×ª ×œ×¤×¢×•×œ×”</h3>
                    <p><strong>××•××œ×¥ ×œ×”×ª××§×“ ×‘-5 ×”××ª×’×¨×™× ×”××•×‘×™×œ×™×:</strong></p>
                    <ul>
            `;
            
            top5.forEach((result) => {
                html += `<li>${result.challenge} (×¦×™×•×Ÿ: ${result.overall.toFixed(2)})</li>`;
            });
            
            html += `
                    </ul>
                    <p><strong>×©×™×§×•×œ×™× × ×•×¡×¤×™×:</strong></p>
                    <ul>
                        <li>×‘×“×§×• ××ª×’×¨×™× ×¢× ×¡×˜×™×™×ª ×ª×§×Ÿ ×’×‘×•×”×” ×‘×¦×™×•× ×™× (×¤×¢×¨×™× ×’×“×•×œ×™× ×‘×™×Ÿ ×”××©×ª×ª×¤×™×).</li>
                        <li>×©×§×œ×• ××©××‘×™× ×–××™× ×™× ×œ×‘×™×¦×•×¢ ×”××ª×’×¨×™× ×”××•×‘×™×œ×™×.</li>
                        <li>×”×ª×™×™×¢×¦×• ×¢× ×‘×¢×œ×™ ×¢× ×™×™×Ÿ × ×•×¡×¤×™× ×œ×’×‘×™ ×”×ª×•×¦××•×ª.</li>
                    </ul>
                </div>
            `;
            
            resultsDiv.innerHTML = html;

            // --- [×©×™× ×•×™] ×”×¦×’×ª ×›×¤×ª×•×¨×™ ×”×¤×¢×•×œ×” ×œ××—×¨ ×©×”×ª×•×¦××•×ª ×”×•×¦×’×• ---
            document.getElementById('resultsActions').style.display = 'block';
        }

        // --- [×—×“×©] ×¤×•× ×§×¦×™×” ×œ×”×•×¨×“×ª ×”×ª×•×¦××•×ª ×›×§×•×‘×¥ CSV ---
        function downloadResults() {
            if (processedResults.length === 0) {
                alert("××™×Ÿ ×ª×•×¦××•×ª ×œ×”×•×¨×“×”.");
                return;
            }

            const headers = [
                "×“×™×¨×•×’",
                "××ª×’×¨",
                "×™×™×©×™××•×ª (×××•×¦×¢)",
                "×¨×œ×•×•× ×˜×™×•×ª (×××•×¦×¢)",
                "×“×—×™×¤×•×ª (×××•×¦×¢)",
                "×–×™×§×” ×œ×™×¢×“×™ ×”××©×¨×“ (×××•×¦×¢)",
                "×¦×™×•×Ÿ ×›×•×œ×œ (×××•×¦×¢)",
                "××¡×¤×¨ ××©×™×‘×™× ×œ××ª×’×¨"
            ];

            // ×”××¨×” ×œ×¤×•×¨××˜ CSV
            let csvContent = headers.join(",") + "\n";
            processedResults.forEach((result, index) => {
                const row = [
                    index + 1,
                    result.challenge,
                    result.implementability.toFixed(2),
                    result.relevance.toFixed(2),
                    result.urgency.toFixed(2),
                    result.alignment.toFixed(2),
                    result.overall.toFixed(2),
                    result.responseCount
                ];
                csvContent += row.join(",") + "\n";
            });

            // ×™×¦×™×¨×ª ×§×•×‘×¥ ×•×”×•×¨×“×”
            // ×”×•×¡×¤×ª BOM ×›×“×™ ×©××§×¡×œ ×™×–×”×” ×¢×‘×¨×™×ª × ×›×•×Ÿ ×‘×¤×ª×™×—×” ×™×©×™×¨×”
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                const date = new Date().toISOString().slice(0, 10);
                link.setAttribute("href", url);
                link.setAttribute("download", `×ª×•×¦××•×ª_×ª×™×¢×“×•×£_${date}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
</body>
</html>
